<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Departaments</title>
</head>

<body>
    
    <!-- #include "header.html" -->
    <!-- #include "noty.html" -->

    <div class="container-fluid">
        <div class="row justify-content-end">
            <span class="content-corner col-lg-10 d-none d-lg-block"></span>
            <!-- #include "loader.html" -->

            <div class="col-lg-10" id="content" data-bind="visible: true" style="display: none; margin-top: 80px; height: calc(100vh - 80px);">

                <h1>Employees</h1>

                <div data-bind="visible: hasEmployees()" class="mt-3 mb-3 p-2 table-wrap">
                    <table id="table"
                        class="table table-striped table-bordered table-striped table-sm mb-0 align-middle">
                        <thead>
                            <tr>
                                <th scope="col-auto"></th>
                                <th scope="col-auto">FirstName</th>
                                <th scope="col-auto">LastName</th>
                                <th scope="col-auto">MidleName</th>
                                <th scope="col-auto">Department</th>
                                <th scope="col-auto">Salary</th>
                                <th scope="col-auto"></th>
                            </tr>
                        </thead>
                        <tbody class="table-light" data-bind="foreach: employees">
                            <tr class="table-string" id="employees-table">
                                <td style="text-align: center;">
                                    <input class="delete-employee-checkbox" type="checkbox"
                                        data-bind="checked: $root.selectedEmployees, value: $data" />
                                </td>
                                <td data-bind="text: lastName" scope="col"></td>
                                <td data-bind="text: firstName" scope="col"></td>
                                <td data-bind="text: midleName" scope="col"></td>
                                <td data-bind="text: department.name" scope="col"></td>
                                <td data-bind="text: `${salary()} $`" scope="col"></td>
                                <td class="d-flex justify-content-end" scope="col">
                                    <button type="button" class="btn btn-primary me-2" data-bind="click: $parent.editEmployee">Edit</button>
                                    <button type="button" class="btn btn-danger" data-bind="click: $parent.deleteEmployee">Delete</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <span style="color: #fff;"> 1.2.3...</span>
                </div>

                <button class="btn btn-primary mb-3" data-bind="click: addEmployee"><i
                        class="fas fa-plus-circle"></i>Add Employee</button>
                <button class="btn btn-danger mb-3"
                    data-bind="visible: selectedEmployees().length ,click: deleteSelectedEmployees">Delete
                    selected</button>

                <p data-bind="ifnot: hasEmployees">Employees not found</p>
            </div>

            <div data-bind="modal: {
                visible: editEmployeeDialogVisible,
                header: { name: 'editEmployeeHeaderTemplate', data: { label: editEmployeeTitle } },
                body: { name: 'editEmployeeBodyTemplate', data: editEmployeeData },
                footer: { name: 'employeeFooterTemplate', data: $data }
            }">
            </div>

            <script type="text/html" id="employeeFooterTemplate">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Close</button>
                <button class="btn btn-success" data-bind="text: $root.saveButtonTitle,
                                                           click: $root.handleSaveButton,
                                                           enable: editEmployeeData().target.validationModel.isValid,
                                                           "/>
            </script>

            <script type="text/html" id="editEmployeeHeaderTemplate">
                <h5 class="modal-title" data-bind="text: label"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </script>
            <script type="text/html" id="editEmployeeBodyTemplate">
                <form data-bind="with: target">
                    <div class="form-floating mb-3">
                        <input data-bind="value: lastName, class: lastName.isValid() ? 'is-valid' : 'is-invalid'"
                            type="text" class="form-control">
                        <label>lastName</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input data-bind="value: firstName, class: firstName.isValid() ? 'is-valid' : 'is-invalid'"
                            type="text" class="form-control">
                        <label>firstName</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input data-bind="value: midleName, class: midleName.isValid() ? 'is-valid' : 'is-invalid'"
                            type="text" class="form-control">
                        <label>midleName</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input data-bind="value: salary, class: salary.isValid() ? 'is-valid' : 'is-invalid'"
                            type="number" class="form-control">
                        <label>salary</label>
                    </div>
                    <div class="form-floating mb-3">
                        <select class="form-select " data-bind="class: department.id.isValid() ? 'is-valid' : 'is-invalid',
                                                                options: $parent.departments,
                                                                optionsText: 'name',
                                                                optionsValue: 'id',
                                                                value: department.id,
                                                                optionsCaption: 'select department',
                                                                valueAllowUnset: true
                                                                ">
                        </select>
                        <label>department</label>
                    </div>
                </form>
            </script>  
        </div>
    </div>
    <script>
        
        function confirmDialog(text, callback) {
            const n = new Noty({
                layout: 'topRight',
                theme: 'sunset',
                type: 'alert',
                text: `<p>${text}</p>`,
                buttons: [
                    Noty.button('YES', 'btn btn-success', function () {
                        callback();
                        n.close();
                    }, {
                        id: 'button1',
                        'data-status': 'ok'
                    }),

                    Noty.button('NO', 'btn btn-danger ms-2', function () {
                        n.close();
                    })
                ]
            });
            n.show();
        }

        function getEmployees() {
            const baseUrl = window.location.href;
            const departamentId = baseUrl.substring(baseUrl.lastIndexOf('/') + 1);
            const url = isNaN(departamentId) || departamentId == "" ? "/api/employee" :
                "/api/employee/department/" + departamentId;
            return $.ajax({
                url: url,
                type: 'GET',
                error: function (xhr) {
                    notifyAjaxError(xhr);
                }
            });
        }

        function getDepartments() {
            return $.ajax({
                url: '/api/department/light',
                type: 'GET',
                error: function (xhr) {
                    notifyAjaxError(xhr);
                }
            })
        }

        function EmployeeViewModel(data) {
            let self = this;
            let employee = data || {};

            this.id = employee.id || '';
            this.firstName = ko.observable(employee.firstName || '').extend({
                required: true,
                maxLength: 20
            });
            this.lastName = ko.observable(employee.lastName || '').extend({
                required: true,
                maxLength: 20
            });
            this.midleName = ko.observable(employee.midleName || '').extend({
                required: true,
                maxLength: 20
            });
            this.salary = ko.observable(employee.salary || '').extend({
                required: true,
            });

            this.department = new DepartmentViewModel(employee.department);

            this.fullName = ko.pureComputed(function () {
                return self.lastName() + ' ' + self.firstName() + ' ' + self.midleName();
            })

            this.validationModel = ko.validatedObservable({
                firstName: this.firstName,
                lastName: this.lastName,
                midleName: this.midleName,
                salary: this.salary,
                department: this.department
            });

            this.clone = function () {
                return new EmployeeViewModel({
                    id: self.id,
                    firstName: self.firstName(),
                    lastName: self.lastName(),
                    midleName: self.midleName(),
                    salary: self.salary(),
                    department: {
                        id: self.department.id(),
                        name: self.department.name
                    }
                });
            }
        }

        function DepartmentViewModel(data) {
            data = data || {};
            this.id = ko.observable(data.id || '').extend({
                required: true
            });
            this.name = data.name || '';

            this.validationModel = ko.validatedObservable({
                id: this.id
            });
        }

        function FormViewModel(data) {
            let self = this;

            this.target = data;

            this.departments = ko.observableArray();
            getDepartments().then(data => {
                self.departments(ko.utils.arrayMap(data, function (e) {
                    return new DepartmentViewModel(e);
                }));
            });
        }

        function PageViewModel(data) {
            let self = this;

            const employees = ko.utils.arrayMap(data, function (e) {
                return new EmployeeViewModel(e);
            });
            this.employees = ko.observableArray(employees);
            this.hasEmployees = ko.pureComputed(function () {
                return self.employees().length ? true : false;
            })
            this.editEmployeeDialogVisible = ko.observable(false);
            this.editEmployeeMode = ko.observable();
            this.editEmployeeTitle = ko.pureComputed(function () {
                return self.editEmployeeMode() === 'create' ? 'Create Employee' : 'Edit Employee';
            });
            this.saveButtonTitle = ko.pureComputed(function () {
                return self.editEmployeeMode() === 'create' ? 'Create' : 'Save';
            });
            this.editEmployeeData = ko.observable(new FormViewModel(new EmployeeViewModel()));

            this.addEmployee = function () {
                self.editEmployeeMode('create');
                self.editEmployeeData(new FormViewModel(new EmployeeViewModel()));
                self.editEmployeeDialogVisible(true);
            }

            let targetEmployee;
            this.editEmployee = function (data) {
                targetEmployee = data;
                self.editEmployeeMode('edit');
                self.editEmployeeData(new FormViewModel(data.clone()));
                self.editEmployeeDialogVisible(true);
            }

            this.handleSaveButton = function () {
                let employee = self.editEmployeeData().target;      
                const payload = {
                    id: employee.id ? employee.id : undefined,
                    firstName: employee.firstName(),
                    lastName: employee.lastName(),
                    midleName: employee.midleName(),
                    departmentId: employee.department.id(),
                    salary: employee.salary()
                };

                $.ajax({
                    contentType: 'application/json',
                    url: '/api/employee/',
                    type: self.editEmployeeMode() === 'create' ? 'POST' : 'PUT',
                    data: ko.toJSON(payload),
                    success: function (data) {
                        self.editEmployeeMode() === 'create' ?
                            self.employees.push(new EmployeeViewModel(data.response)) :
                            self.employees.replace(targetEmployee, new EmployeeViewModel(
                                data))
                        notifyInfo(`Employee ${data.fullName} has been saved`);
                    },
                    error: function (xhr) {
                        notifyAjaxError(xhr);
                    }
                }).then(function () {
                    self.editEmployeeDialogVisible(false);
                });
            }

            this.selectedEmployees = ko.observableArray();
            this.deleteSelectedEmployees = function () {
                const ids = ko.utils.arrayMap(self.selectedEmployees(), function (e) {
                    return e.id;
                });
                confirmDialog(`Do you really want to delete ${ids.length} employees?`, function () {
                    $.ajax({
                        ContentType: 'application/json',
                        url: '/api/employee/deleteList',
                        type: 'DELETE',
                        data: JSON.stringify(ids),
                        success: function () {
                            const employees = ko.utils.arrayFilter(self.employees(),
                                function (e) {
                                    return self.selectedEmployees.indexOf(e) === -1;
                                });
                            self.selectedEmployees([]);
                            self.employees(employees);
                            notifyWarning(`Deleted ${ids.length} employees`);
                        },
                        error: function (xhr) {
                            notifyAjaxError(xhr);
                        }
                    });
                })
            }

            this.deleteEmployee = function (data) {
                confirmDialog(`Do you really want to delete</br>${data.fullName()}?`, function () {
                    $.ajax({
                        contentType: 'application/json',
                        url: '/api/employee/',
                        type: 'DELETE',
                        data: JSON.stringify(ko.toJS(data.id)),
                        success: function () {
                            self.employees.remove(data);
                            notifyWarning(`Deleted: ${data.fullName()}`);
                        },
                        error: function (xhr) {
                            notifyAjaxError(xhr);
                        }
                    });
                })
            }
        }

        $(document).ready(function () {
            setActiveMenu('employees');
            ko.validation.init({
                decorateInputElement: true,
                insertMessages: true,
                grouping: {
                    deep: true,
                    live: true,
                    observable: true
                }
            });

            getEmployees().then(data => {
                ko.applyBindings(new PageViewModel(data));
            });
        });
    </script>
</body>

</html>