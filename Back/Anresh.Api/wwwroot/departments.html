<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Departaments</title>
</head>

<body>

    <!-- #include "header.html" -->
    <!-- #include "noty.html" -->

    <div class="container-fluid">
        <div class="row justify-content-end">
            <span class="content-corner col-lg-10 d-none d-lg-block"></span>
            <!-- #include "loader.html" -->

            <div class="col-lg-10" id="content" data-bind="visible: true"
                style="display: none; margin-top: 80px; height: calc(100vh - 80px);">

                <h1>Departments</h1>

                <div class="mt-3 p-2 table-wrap">
                    <table id="table"
                        class="table table-striped table-bordered table-striped table-sm mb-0 align-middle">
                        <thead>
                            <tr>
                                <th class="col-auto">id</th>
                                <th class="col-12">Name</th>
                                <th class="col-auto"></th>
                            </tr>
                        </thead>
                        <tbody class="table-light" data-bind="foreach: departments">
                            <tr class="table-string">
                                <th class="pointer" data-bind="text: id, click:  $root.goToEmployees"></th>
                                <td class="pointer" data-bind="text: name, click:  $root.goToEmployees"></td>
                                <td>
                                    <div class="d-flex">
                                        <button data-bind="click: $root.handleEditDepartment"
                                            class="btn btn-primary">Edit</button>
                                        <button data-bind="click: $root.handleDeleteDepartment" class="btn btn-danger"
                                            style="margin-left: 5px;">Delete</button>
                                    </div>

                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <span style="color: #fff;"> 1.2.3...</span>
                </div>

                <button class="btn btn-primary mb-1 mt-3" data-bind="click: handleAddDepartment"><i
                        class="fas fa-plus-circle"></i> Add Department</button>

                <div data-bind="modal: {visible: visibleDepartmentBodyTemplate,
                                        header: { name: 'departmentHeaderTemplate', data: { label: departmentTitle } },
                                        body: { name: departmentModalBodyTemplate, data: $data },
                                        footer: { name: 'departmentFooterTemplate', data: $data }
                                        }">
                </div>

                <script type="text/html" id="departmentHeaderTemplate">
                    <h5 class="modal-title" data-bind="text: label"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </script>

                <script type="text/html" id="departmentFooterTemplate">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        aria-label="Close">Close</button>
                    <button class="btn" data-bind="text: $root.formButtonTitle, 
                                                   click: $root.handleButton,
                                                   enable: currentDepartmentData().validationModel.isValid(),
                                                   class: departmentModalMode() === 'delete' ? 'btn-danger' : 'btn-success'
                                                   "/>
                </script>

                <!-- Edit/Create -->
                <script type="text/html" id="editDepartmentBodyTemplate">
                    <form>
                        <div class="form-floating mb-3">
                            <input
                                data-bind="value: currentDepartmentData().name, class: currentDepartmentData().name.isValid() ? 'is-valid' : 'is-invalid' "
                                type="text" class="form-control">
                            <label>name</label>
                        </div>
                    </form>
                </script>


                <!-- Delete -->
                <script type="text/html" id="deleteDepartmentBodyTemplate">
                    <form class="was-validated">
                        <div>
                            <div data-bind="if: hasEmployees">
                                <table style="margin-bottom: 0!important;" class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th scope="col">Last name</th>
                                            <th scope="col">First name</th>
                                            <th scope="col">Midle name</th>
                                            <th scope="col">Salary</th>
                                        </tr>
                                    </thead>
                                </table>
                                <div class="table-scrolled">
                                    <table class="table table-striped">
                                        <tbody data-bind="foreach: currentDepartmentData().employees">
                                            <tr>
                                                <td data-bind="text: lastName"></td>
                                                <td data-bind="text: firstName"></td>
                                                <td data-bind="text: midleName"></td>
                                                <td data-bind="text: salary"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>

                                <div class="form-check">
                                    <label>
                                        <input class="form-check-input pointer" type="radio" value="delete"
                                            data-bind="checked: radioSelected" required />
                                        Delete employees</label>
                                </div>
                                <div class="form-check mb-3">
                                    <label>
                                        <input class="form-check-input pointer" type="radio" value="transfer"
                                            data-bind="checked: radioSelected" required />
                                        Transfer employees</label>
                                </div>
                                <div class="mb-3">

                                    <select class="form-select pointer" required data-bind="visible: radioSelected() === 'transfer',
                                                                                            options: targetDepartments, 
                                                                                            optionsText: 'name',
                                                                                            value: targetDepartment,
                                                                                            optionsCaption: 'select department'
                                                                                            ">
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div data-bind="ifnot: hasEmployees"><span>Employees not found</span></div>
                    </form>
                </script>

            </div>
        </div>
    </div>


    <script>

        function getDepartments() {
            return $.ajax({
                url: 'api/department',
                type: 'GET',
                error: function (xhr) {
                    notifyAjaxError(xhr);
                }
            });
        }

        function DepartmentViewModel(data) {
            let self = this;
            data = data || {};
            this.id = data.id || '';
            this.name = ko.observable(data.name || '').extend({
                required: true,
                maxLength: 20,
            });
            this.validationModel = ko.validatedObservable({
                name: this.name,
            });
            const employees = ko.utils.arrayMap(data.employees, function (e) {
                if (e != null)
                    return new EmployeeViewModel(e)
            })
            this.employees = ko.observableArray(employees[0] !== undefined ? employees : [])

            this.clone = function () {
                return new DepartmentViewModel({
                    id: self.id,
                    name: self.name()
                });
            }

        }

        function EmployeeViewModel(data) {
            data = data || {};
            this.id = data.id || ''
            this.firstName = ko.observable(data.firstName || '');
            this.lastName = ko.observable(data.lastName || '');
            this.midleName = ko.observable(data.midleName || '');
            this.departmentId = ko.observable(data.departmentId || '');
            this.salary = ko.observable(data.salary || '');
        }

        function PageViewModel(data) {
            let self = this;

            const departments = ko.utils.arrayMap(data, function (e) {
                return new DepartmentViewModel(e);
            });
            this.departments = ko.observableArray(departments);
            this.currentDepartmentData = ko.observable(new DepartmentViewModel());
            this.visibleDepartmentBodyTemplate = ko.observable(false);
            this.departmentModalBodyTemplate = ko.observable('editDepartmentBodyTemplate')
            this.departmentModalMode = ko.observable();
            this.departmentTitle = ko.pureComputed(function () {
                switch (self.departmentModalMode()) {
                    case 'create':
                        return 'Create Department'
                        break;
                    case 'edit':
                        return 'Edit Department'
                        break;
                    case 'delete':
                        return 'Delete Department'
                        break;
                }
            });
            this.formButtonTitle = ko.pureComputed(function () {
                switch (self.departmentModalMode()) {
                    case 'create':
                        return 'Create'
                        break;
                    case 'edit':
                        return 'Edit'
                        break;
                    case 'delete':
                        return 'Delete'
                        break;
                }
            });

            this.handleAddDepartment = function (data) {
                self.departmentModalBodyTemplate('editDepartmentBodyTemplate')
                self.departmentModalMode('create');
                self.currentDepartmentData(new DepartmentViewModel());
                self.visibleDepartmentBodyTemplate(true);
            }

            let cloneData;
            this.handleEditDepartment = function (data) {
                cloneData = data;
                self.departmentModalBodyTemplate('editDepartmentBodyTemplate')
                self.departmentModalMode('edit');
                self.currentDepartmentData(data.clone());
                self.visibleDepartmentBodyTemplate(true);
            }

            this.hasEmployees = ko.pureComputed(function () {
                return self.currentDepartmentData().employees().length > 0;
            })
            this.radioSelected = ko.observable();
            this.targetDepartment = ko.observable();

            this.targetDepartments = ko.pureComputed(function () {
                return ko.utils.arrayFilter(self.departments(), function (e) {
                    return self.currentDepartmentData() !== e;
                });
            });
            this.handleDeleteDepartment = function (data) {
                self.departmentModalBodyTemplate('deleteDepartmentBodyTemplate')
                self.departmentModalMode('delete');
                self.currentDepartmentData(data);
                self.visibleDepartmentBodyTemplate(true);
            }

            deleteDepartment = function (id) {
                $.ajax({
                    contentType: 'application/json',
                    url: '/api/department/',
                    type: 'DELETE',
                    data: ko.toJSON(id),
                    success: function () {
                        self.departments.remove(self.currentDepartmentData());
                        notifyWarning(`deleted: ${self.currentDepartmentData().name()}`);
                    },
                    error: function (xhr) {
                        notifyAjaxError(xhr);
                    }
                }).then(function () {
                    self.visibleDepartmentBodyTemplate(false);
                });
            }

            this.handleButton = function (data) {
                if (self.departmentModalMode() !== 'delete') {
                    const department = ko.toJSON(self.currentDepartmentData());
                    $.ajax({
                        contentType: 'application/json',
                        url: '/api/department/',
                        type: self.departmentModalMode() === 'create' ? 'POST' : 'PUT',
                        data: department,
                        success: function (data) {
                            self.departmentModalMode() === 'create' ?
                                self.departments.push(new DepartmentViewModel(data.response)) :
                                self.departments.replace(cloneData, self.currentDepartmentData())

                            notifyInfo(`Department ${department.name} has been saved`);
                        },
                        error: function (xhr) {
                            notifyAjaxError(xhr);
                        }
                    }).then(function () {
                        self.visibleDepartmentBodyTemplate(false);
                    });
                } else {
                    let departmentId = ko.toJSON(self.currentDepartmentData().id);
                    if (self.hasEmployees()) {
                        if (self.radioSelected() === "delete") {
                            $.ajax({
                                contentType: 'application/json',
                                url: '/api/employee/deleteByDepartment',
                                type: 'DELETE',
                                data: departmentId,
                                success: function () {
                                    notifyWarning(`employees deleted!`);
                                    deleteDepartment(departmentId);
                                },
                                error: function (xhr) {
                                    notifyAjaxError(xhr);
                                }
                            });
                        } else if (self.radioSelected() === "transfer") {
                            let transferRequest = ko.toJSON({
                                oldDepartmentId: self.currentDepartmentData().id,
                                newDepartmentId: self.targetDepartment().id
                            })
                            $.ajax({
                                contentType: 'application/json',
                                url: '/api/employee/transferToTheDepartment',
                                type: 'PUT',
                                data: transferRequest,
                                success: function () {
                                    ko.merge.fromJS(self.targetDepartment().employees(), self
                                        .currentDepartmentData().employees())
                                    notifyInfo(`employees transferred!`);
                                    deleteDepartment(departmentId);
                                },
                                error: function (xhr) {
                                    notifyAjaxError(xhr);
                                }
                            });
                        }
                    } else {
                        deleteDepartment(departmentId)
                    }
                }
            }

            this.goToEmployees = function (data) {
                location.href = 'employees/' + data.id;
            }
        }

        $(document).ready(function () {
            setActiveMenu('departments');
            ko.validation.init({
                decorateInputElement: true,
                insertMessages: true,
                grouping: {
                    deep: true,
                    live: true,
                    observable: true
                }
            });

            getDepartments().then(data => {
                ko.applyBindings(new PageViewModel(data));
            });
        });
    </script>

</body>

</html>