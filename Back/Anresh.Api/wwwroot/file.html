<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>File</title>
</head>

<body>

   <!-- #include "header.html" -->
   <!-- #include "noty.html" -->

   <div class="container-fluid">
    <div class="row justify-content-end">
        <span class="content-corner col-lg-10 d-none d-lg-block"></span>

        <div class="col-lg-10" id="content" data-bind="visible: true" style="display: none; margin-top: 80px; height: calc(100vh - 80px);">

                <div class="flex-end">
                    <button data-bind="click: $root.saveFile" class="btn btn-success shadow-none mt-3 mb-2">Save</button>
                    <button data-bind="click: $root.updateFile" class="btn btn-warning shadow-none mt-3 mb-2">Update</button>
                </div>

            <div style="border-radius: 10px; background-color: #404958; padding: 8px;">
                <h2 style="color: #fff;">File</h2>
                <textarea data-bind="value: text" class="form-control shadow-none" type="text" 
                    style="height: 70vh; overflow-y: scroll; overflow-x: hidden; border-radius: 10px; resize: none; border: none;"></textarea>
            </div>
            </div>

    <script>

        function PageViewModel() {
            let self = this;

            this.text = ko.observable();
            this.latestСhange = ko.observable();

            getText().then(data => {
                self.text(data);
                self.latestСhange(data);
            });

            this.saveFile = function (data) {
                getText().then(data => {
                    if (data !== self.latestСhange()) {
                        const n = new Noty({
                            layout: 'topRight',
                            theme: 'sunset',
                            type: 'alert',
                            text: `<span>The file has been changed, <br />  do you want to overwrite it?</span>`,
                            buttons: [
                                Noty.button('YES', 'btn btn-success', function () {
                                    saveText(self.text())
                                    n.close();
                                }, { id: 'button1', 'data-status': 'ok' }),

                                Noty.button('NO', 'btn btn-danger', function () {
                                    n.close();
                                }),
                                Noty.button('UPDATE', 'btn btn-warning', function () {
                                    getText().then(data => {
                                        self.text(data);
                                        n.close();
                                        notifyInfo('File updated!')
                                    });
                                })
                            ]
                        });
                        n.show();
                    }
                    else {
                        saveText(self.text());
                    }
                    self.latestСhange(data);
                });
                
            }
            this.updateFile = function()  {
                getText().then(data => {
                    self.text(data);
                });
                notifyInfo('File updated!');
            }
        }
        function getText() {
            return $.ajax({
                url: '/api/file/',
                type: 'GET',
                error: function (xhr) {
                    notifyAjaxError(xhr)
                }
            })
        }

        function saveText(data) {
            $.ajax({
                url: '/api/file/',
                type: 'POST',
                data: `text=${data}`,
                success: function () {
                    notifyInfo('Saves changed!');
                },
                error: function (xhr) {
                    notifyAjaxError(xhr)
                }
            })
        }
        $(document).ready(function () {
            setActiveMenu('file');
            ko.applyBindings(new PageViewModel());
        });
    </script>

</body>

</html>